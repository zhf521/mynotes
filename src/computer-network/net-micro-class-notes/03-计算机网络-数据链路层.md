---
title: 计算机网络-数据链路层
order: 3
---

## 数据链路层概述

### 概述

**链路**是从一个结点到相邻结点的一段物理线路，**数据链路**则是在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）

**网络中的主机、路由器等都必须实现数据链路层**

**局域网中的主机、交换机等都必须实现数据链路层**

从层次上来看数据的流动：

![计算机网络-数据链路层01.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层01.png)

仅从数据链路层观察帧的流动：

![计算机网络-数据链路层02.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层02.png)

相关概念：

1. 链路：从一个节点到相邻节点的一段物理线路，而中间没有任何其他的交换节点
2. 数据链路：由实现通信协议的硬件和软件加到链路上构成的
3. 数据链路以帧为单位传输和处理数据

### 三个重要问题

1. 封装成帧

   ![计算机网络-数据链路层03.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层03.png)

2. 差错检测

   在传输过程中可能会产生**比特差错**：1 可能会变成 0， 而 0 也可能变成 1

   ![计算机网络-数据链路层04.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层04.png)

3. 可靠传输

   尽管误码是不能完全避免的，但若能实现发送方发送什么，接收方就能收到什么，就称为可靠传输，**可靠传输是数据链路层中最基本、最重要的问题**，不可靠传输是指在丢弃有误码的帧后，不进行任何其他处理，**接收方不一定能够收到发送方发送的东西**

   > 以上三个问题都是使用**点对点信道的数据链路层**来举例的

**如果使用广播信道的数据链路层除了包含上面三个问题外，还有一些问题要解决**

如图所示，主机A，B，C，D，E通过一根总线进行互连，主机A要给主机C发送数据，代表帧的信号会通过总线传输到总线上的其他各主机，那么主机B，D，E如何知道所收到的帧不是发送给她们的，主机C如何知道发送的帧是发送给自己的呢

![计算机网络-数据链路层05.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层05.png)

可以用编址（地址）的来解决，将帧的目的地址添加在帧中一起传输

还有数据碰撞问题：

![计算机网络-数据链路层06.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层06.png)

> 随着技术的发展，交换技术的成熟，在有线（局域网）领域使用**点对点链路**和**链路层交换机**的**交换式局域网**取代了共享式局域网，在无线局域网中仍然使用的是共享信道技术

## 封装成帧

### 介绍

封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧

**帧头和帧尾中包含有重要的控制信息**

![计算机网络-数据链路层07.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层07.png)

问：发送方的数据链路层将上层交付下来的协议数据单元封装成帧后，还要通过物理层，将构成帧的各比特，转换成电信号交给传输媒体，那么接收方的数据链路层如何从物理层交付的比特流中提取出一个个的帧？

答：需要帧头和帧尾来做**帧定界**

![计算机网络-数据链路层08.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层08.png)

但并不是每一种数据链路层协议的帧都包含有帧定界标志，例如：

![计算机网络-数据链路层09.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层09.png)

> 前导码:
>
> + 前同步码：作用是使接收方的时钟同步
> + 帧开始定界符：表明其后面紧跟着的就是MAC帧

其帧的提取由物理层添加的前导码来识别开始，并且按照稳定的时钟周期，在每一帧的结束会由96比特发送时间的间隔，以此来识别一个帧的结束，因此，MAC帧不需要帧结束定界符

![计算机网络-数据链路层10.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层10.png)

### 透明传输

透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在一样

帧界定标志也就是个特定数据值，如果在上层交付的协议数据单元中， 恰好也包含这个特定数值，接收方就不能正确接收，所以数据链路层应该对上层交付的数据有限制，其内容不能包含帧定界符的值

![计算机网络-数据链路层11.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层11.png)

透明传输的实现：

+ 面向字节的物理链路使用字节填充（byte stuffing）或字符填充（character stuffing）的方法实现透明传输
  + 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是1B)
  + 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符
  + 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个
+ 面向比特的物理链路使用比特填充的方法实现透明传输
  + 在数据链路层中发送帧前扫描帧的数据部分，若出现连续的5个1，将在后续增加1个0(因为帧定界标志符为01111110)
  + 在接收方数据链路层接收帧时，帧的数据部分，若出现连续的5个1，将后续的一个0换成1

### 总结

![计算机网络-数据链路层12.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层12.png)

## 差错检测

### 介绍

![计算机网络-数据链路层13.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层13.png)

### 奇偶校验

![计算机网络-数据链路层14.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层14.png)

### 循环冗余校验CRC(Cyclic Redundancy Check)

![计算机网络-数据链路层15.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层15.png)

![计算机网络-数据链路层16.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层16.png)

![计算机网络-数据链路层17.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层17.png)

![计算机网络-数据链路层18.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层18.png)

![计算机网络-数据链路层19.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层19.png)

## 可靠传输

### 基本概念

#### 比特差错

根据**差错检测技术**，接收方的数据链路层可以检测出帧在传输过程中是否出现了误码（比特错误）

数据链路层向上提供的服务类型有两种情况：

+ 可靠传输：丢弃有误码的帧后，会进行其他措施来确保接收方主机还可以重新收到被丢弃的这个帧的正确副本，来**实现发送方发送什么，接收方就能接收到什么**
+ 不可靠传输：在丢弃有误码的帧后，不进行任何其他处理，**接收方不一定能够收到发送方发送的东西**

一般情况下，**有线链路的误码率比较低**，为了减小开销，不要求数据链路层向上提供可靠传输服务。即使出现了误差，**可靠传输的问题由其上层解决。**对于**无线链路，误码率较高，因此要求数据链路层必须向上层提供可靠传输服务**

#### 分组丢失

路由器输入队列快满了，主动丢弃收到的分组，造成分组丢失

![计算机网络-数据链路层20.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层20.png)

#### 分组失序

由于传输过程中选择失序的问题，接收方实际收到的数据与发送方发送的分组顺序不同造成分组失序

![计算机网络-数据链路层21.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层21.png)

#### 分组重复

由于某些原因，有些分组在网络中滞留了，没有及时到达接收端，这可能会造成发送端对该分组的重发，重发的分组到达接收端，但一段时间后，滞留在网络的分组也到达了接收端，这就造成分组重复的传输差错

![计算机网络-数据链路层22.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层22.png)

![计算机网络-数据链路层23.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层23.png)

### 三种可靠传输协议

- 停止-等待协议SW
- 回退N帧协议GBN
- 选择重传协议SR

> 这三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中

#### 停止-等待协议SW

四个基本原则：

1. 确认与否认

   ![计算机网络-数据链路层24.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层24.png)

   在停止等待协议中：

   - 在每个数据发送后，接收方接到后会发送ACK（确认）信号确认无误收到，发送收到ACK信号后便开始发送下一个数据
   - 接收方检测收到数据出现误码后，会发送NAK（否认）信号，发送方接收到NAK信号后会**重新发送缓存区中的数据**
   - 因此，在此过程中，发送方与接收方一直处于一种停止等待对方的过程，在此过程中要进行确认与否认，这也是停止-等待协议的最基本原则

2. 超时重传

   此原则可以避免当数据传输过程中出现丢失，**导致接收方一直等待不到数据传送到达，而发送方又在等待接受方发送确认信号**，**系统处于互等的请况**

   ![计算机网络-数据链路层25.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层25.png)

3. 确认丢失

   此原则可以避免：**接收方发送ACK信号后，由于传输问题出现ACK信号丢失**，导致发送方没收到确认信号，重传分组，此时接收方重新接收到一样的分组，造成**分组重复错误**

   ![计算机网络-数据链路层26.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层26.png)

   一个比特就是0或者1，只要接收的分组信号与上一次不同便可以。这样子就可以避免重复的问题

   ![计算机网络-数据链路层27.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层27.png)

4. 确认迟到

   此原则可以避免：**接收方发送ACK信号后，由于传输问题出现ACK信号迟到**，导致发送方没收到确认信号，重传分组，同时开始传输下一个分组，此时ACK到达，但是此时超时重传的分组已经发送出去，接收方接收到后会发送一个一样的ACK信号

   ![计算机网络-数据链路层28.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层28.png)

   > 注意，图中最下面那个数据分组与之前序号为0的那个数据分组不是同一个数据分组

   在点对点通信中，传输的时钟周期比较固定，很少出现确认迟到的情况，可以不用给确认分组编号

注意事项：

![计算机网络-数据链路层29.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层29.png)

停止-等待协议的信道利用率：

假设收发双方之间是一条直通的信道

- **TD**：是发送方发送数据分组所耗费的发送时延
- **RTT**：是收发双方之间的往返时间
- **TA**：是接收方发送确认分组所耗费的发送时延

TA一般都远小于TD，可以忽略，当RTT远大于TD时，信道利用率会非常低

![计算机网络-数据链路层30.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层30.png)

- 当往返时延RTT远大于数据帧发送时延TD时（卫星电路），信道利用率非常低
- 若出现重传，信道利用率还要减低
- 因此就出现了另外两种协议：回退N帧协议GBN、选择重传协议SR

总结：

![计算机网络-数据链路层31.png](https://zhf-picture.oss-cn-qingdao.aliyuncs.com/my-img/计算机网络-数据链路层31.png)

#### 回退N帧协议GBN



